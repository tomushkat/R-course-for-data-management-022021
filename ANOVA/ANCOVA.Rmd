---
title: "ANCOVA - Analysis of Covarience"
author: "P-Value Analitics"
date: "2/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Goal - find the relation between Monthly Game Entry by Education controling the castomers' Age
# Libraries
```{r, warning=FALSE, message=FALSE}
pacman::p_load(tidyverse, car, rstatix, effectsize)
```

# Uploading data
## From the computer
```{r, warning=FALSE, message=FALSE}
Data <- read_csv('C:\\Tom\\pvalue\\2021\\2\\R course for Frequentist analytics 022021\\Data.csv')
```


## From Git

1) Go to the github repository link where you have the CSV file
2) Click on the **raw** option present on the top right of the data
3) This will open a new window in the browser
4) The link should be like **https://raw.githubusercontent.com/..**
5) You have to use this link to download csv file from the Github

```{r, warning=FALSE, message=FALSE}
URL <- c('https://raw.githubusercontent.com/tomushkat/R-course-for-Frequentist-analytics-022021/main/Data.csv')
dataGit <- read_csv(url(URL))
```

## From Google Drive

1) Go to 'File'
2) Go to 'Publish to the web'
3) Under 'Link' change to the target sheet
4) Change to 'Comma-separated values (.csv)'
5) Choose 'Publish' and confirm
6) Copy the URL

```{r, warning=FALSE, message=FALSE}
urlData <- 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3jiyLqz265ejq7G0BvNyCZtAv4a8C4ADhkQ2YBPLvHTCELRB-4g_13_nsftxJU-QDCTfPdi3SSLNe/pub?gid=1570908824&single=true&output=csv'
dataDrive <- read_csv(url(urlData))
```



```{r, warning=FALSE, message=FALSE}
Data %>% 
  mutate(Month = as.factor(Month),
         Month = ordered(Month, levels = c("Jenuary", "February", 'March'))) %>% 
  drop_na(ID, Month, Education, Purchase) %>% 
  group_by(ID, Month, Education) %>% 
  summarise(Purchase)

unitedData <- Data %>% 
  drop_na(ID, Gender, Month, Purchase, monthlyIncome, Age, Stage, Score) %>% 
  mutate(unitedEducation = ifelse(Education == 'Soilder' | Education == 'Pupil', 'soilderPupil', Education),
         unitedEducation = as.factor(unitedEducation),
         unitedEducation = ordered(unitedEducation, levels = c("soilderPupil", "BA", 'MA', 'PhD'))) %>% 
  group_by(ID, Gender, Age, unitedEducation) %>% 
  summarise(unitedPurchase = mean(Purchase),
            unitedmonthlyIncome = mean(monthlyIncome),
            latestStage = max(Stage),
            latestScore = max(Score),
            unitedmonthlyGameEntry = mean(monthlyGameEntry))
                                          

head(unitedData)
```

# Assumptions chaking
## Normality
```{r, warning=FALSE, message=FALSE}
unitedData %>%
  group_by(unitedEducation) %>%
  shapiro_test(unitedmonthlyGameEntry)   # rstatix package
```

## Correlation
```{r, warning=FALSE, message=FALSE}
cor.test(unitedData$unitedmonthlyGameEntry, unitedData$Age)
plot(unitedData$unitedmonthlyGameEntry, unitedData$Age)
```

## Variances equality
```{r, warning=FALSE, message=FALSE}
leveneTest(unitedData$unitedmonthlyGameEntry ~ unitedData$unitedEducation)  # car packages
```

# Hypothesis confirming
```{r, warning=FALSE, message=FALSE}
Model <- aov(unitedmonthlyGameEntry ~ unitedEducation * Age, data = unitedData)

summary(Model)
```

### Effect size
```{r, warning=FALSE, message=FALSE}
effectsize(Model, type = 'eta')      # effectsize
```

### Post hoc pairwise comparisons
```{r, warning=FALSE, message=FALSE}
pairwise.t.test(unitedData$unitedmonthlyGameEntry, unitedData$unitedEducation, 
                 p.adjust.method = "BH")
```

## Summary statistics
```{r, warning=FALSE, message=FALSE}
unitedData %>% 
  drop_na(unitedmonthlyGameEntry, unitedEducation) %>% 
  group_by(unitedEducation) %>% 
  summarise(Mean = round(mean(unitedmonthlyGameEntry), 2),
            SD   = round(sd(unitedmonthlyGameEntry), 2),
            N    = length(unitedmonthlyGameEntry))
```

## Visualization
```{r, warning=FALSE, message=FALSE}
unitedData %>% 
    drop_na(unitedmonthlyGameEntry, unitedEducation) %>% 
  ggplot(aes(x = unitedEducation, y = unitedmonthlyGameEntry, fill = unitedEducation)) + 
    geom_bar(stat = 'summary', position = position_dodge()) +
      geom_jitter(aes(x = unitedEducation, y = unitedmonthlyGameEntry, fill = unitedEducation), color = 'blue') + 
    stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), 
               geom = "errorbar", color = "red", width = 0.2) +
    stat_summary(fun.y = mean, geom = "point", color = "red") +
    theme_classic() + ylab('Purchase') + xlab('Education level') + 
    ggtitle('ANCOVA model bar plot: Monthly Game Entry ~ Education controling Age') + theme(plot.title = element_text(hjust = 0.5)) 

unitedData %>% 
    drop_na(unitedmonthlyGameEntry, unitedEducation) %>% 
    ggplot(aes(x = unitedmonthlyGameEntry, y = Age)) +
  geom_point(aes(color = unitedEducation)) + 
  geom_smooth(aes(fill = unitedEducation), method = 'lm') +
  theme_classic() + ylab('Age') + xlab('Monthly Game Entry') + 
    ggtitle('ANCOVA model scatter plot: Monthly Game Entry by Education controling Age') + theme(plot.title = element_text(hjust = 0.5)) 
```


