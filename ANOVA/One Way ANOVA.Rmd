---
title: "One-Way ANOVA (Analysis of variace)"
author: "P-Value Data Analytics"
date: "3/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)   # Do not run
```

# Goal - find the differences at the number of purchaes by education levels for all months together

# Libraries

```{r, warning=FALSE, message=FALSE}
pacman::p_load(tidyverse, car, effectsize)
```

## From the Git Hub

1) Go to the GitHub repository link where you have the CSV file.
2) Click on the **raw** option present on the top right of the data.
3) This will open a new window in the browser.
4) The link should be like **https://raw.githubusercontent.com/..**.
5) You have to use this link to download csv file from Github.

```{r, warning=FALSE, message=FALSE}
URL <- c('https://raw.githubusercontent.com/tomushkat/R-course-for-data-management-022021/main/anovaData.csv')
dataGit <- read_csv(url(URL))
```

# Preparing data

## Which education levels do we have?
Using the **!duplicated** command we remove from the data duplicated IDs.
The **table** command produce the frequency of every value.
```{r, warning=FALSE, message=FALSE}

uniqueID <- dataGit[!duplicated(dataGit$ID), ]

table(uniqueID$Education)
round(100 * table(uniqueID$Education) / length(na.omit(uniqueID$Education)), 1)
```

## Convert charecter to factor
In order to see the categories by non alphabetic order, using the **mutate** and **as.factor** commands we can transform the variable from **character** into **factor**. 
```{r, warning=FALSE, message=FALSE}
dataGit <- dataGit %>% 
  mutate(Education = as.factor(Education))
```

The **levels** command show the levels of the variable (now it is by alphabetic order)
## Show the levels
```{r, warning=FALSE, message=FALSE}
levels(dataGit$Education)
```

## Change levels  

Using the **mutate** and **ordered** commands we can set the new levels.
```{r, warning=FALSE, message=FALSE}

dataGit <- dataGit %>% 
  mutate(Education = ordered(Education, levels = c("Pupil", "Soldier", "BA", 'MA', 'PhD')))

levels(dataGit$Education)
```

We can do the same to the months while using the **drop_na**, **group_by** and **summarise** in order to see the number purchases for every ID at month.
## Grouping by month
```{r, warning=FALSE, message=FALSE}
dataGit %>% 
  mutate(Month = as.factor(Month),
         Month = ordered(Month, levels = c("January", "February", 'March'))) %>% 
  drop_na(ID, Month, Education, Purchase) %>% 
  group_by(ID, Month, Education) %>% 
  summarise(Purchase)
```

Now, we need to average the purchases by ID and month.
We assign the summarized data into the variable unitedData.
```{r, warning=FALSE, message=FALSE}
unitedData <- dataGit %>% 
  drop_na(ID, Education, Month, Purchase) %>% 
  group_by(ID, Education) %>% 
  summarise(unitedPurchase = mean(Purchase))

head(unitedData)
```

Using the **table** command we can see that there are not enough cases to do ANOVA for the Soldiers group.
```{r, warning=FALSE, message=FALSE}
table(unitedData$Education)
round(100 * table(unitedData$Education) / length(na.omit(unitedData$Education)), 1)
```

## Unite education levels

Using the **mutate**, **ifelse**, **as.factor** and **ordered** commands we unite the Soldiers and pupils groups and set the levels again. 
```{r, warning=FALSE, message=FALSE}
unitedData <- unitedData %>% 
  mutate(Education = as.character(Education),
         unitedEducation = ifelse(Education == 'Soldier' | Education == 'Pupil', 'Soldier_pupil', Education),
         unitedEducation = as.factor(unitedEducation),
         unitedEducation = ordered(unitedEducation, levels = c("Soldier_pupil", "BA", 'MA', 'PhD')))

```


## Summary statistics
```{r, warning=FALSE, message=FALSE}
unitedData %>% 
  drop_na(unitedEducation, unitedPurchase) %>% 
  group_by(unitedEducation) %>% 
  summarise(Mean = round(mean(unitedPurchase), 2),
            SD   = round(sd(unitedPurchase), 2),
            N    = length(unitedPurchase))
```



# Assumptions and preleminary tests
## Check univariate normality assumption - p-value greater than 0.05

## Variances equality - p-values greater than 0.05

Using the **leveneTest** command from the **car** package we can test the equality of the variances.
```{r, warning=FALSE, message=FALSE}
leveneTest(unitedData$unitedPurchase ~ unitedData$unitedEducation)  # car packages
```

# Hypothesis testing - One Way ANOVA
## Vraiances are equal
### Model and summary statistics
The one-way ANOVA is performed using the **aov** command.
In order to see the results we need to use the **summary** command.
```{r, warning=FALSE, message=FALSE}
modelVarEqual <- aov(unitedPurchase ~ unitedEducation, data = unitedData)   # If the Variances are equal
summary(modelVarEqual)
```

### Effect size - eta squered
The effect size is calculated using the **effectsize** command from the package **effectsize**. Indicating the type is not mandatory.
```{r, warning=FALSE, message=FALSE}
effectsize(modelVarEqual, type = 'eta')      # effectsize
```

### Post hoc pairwise comparisons
The pairwise.t.test conduced all the pairwise comparisons. The X item is the response vector and the g item is the grouping vector or factor.
The p.adjust.method is the correction method.
```{r, warning=FALSE, message=FALSE}
pairwise.t.test(x = unitedData$unitedPurchase, g = unitedData$unitedEducation, 
                 p.adjust.method = "bonferroni")

unitedData %>% 
  drop_na(unitedEducation, unitedPurchase) %>% 
  group_by(unitedEducation) %>% 
  summarise(Mean = round(mean(unitedPurchase), 2),
            SD   = round(sd(unitedPurchase), 2),
            N    = length(unitedPurchase))
```

## Vraiances are not equal
### Model and summary statistics
When the variances are not equal you can use the **oneway.test** command from the car package. Make sure the **var.equal = FALSE**.
```{r, warning=FALSE, message=FALSE}
modelVarNoequal <- oneway.test(unitedPurchase ~ unitedEducation, var.equal = FALSE, data = unitedData)   # If the Variances are not equal
modelVarNoequal
```

### Effect size - eta squered'
The effect size is calculated using the **effectsize** command from the package **effectsize**. Indicating the type is not mandatory.
```{r, warning=FALSE, message=FALSE}
effectsize(modelVarNoequal, type = 'eta')
```


### Post hoc pairwise comparisons
The pairwise.t.test conduced all the pairwise comparisons. The X item is the response vector and the g item is the grouping vector or factor.
The p.adjust.method is the correction method. **pool.sd** should be equal to FALSE.

```{r, warning=FALSE, message=FALSE}
pairwise.t.test(unitedData$unitedPurchase, unitedData$unitedEducation, 
                 p.adjust.method = "bonferroni", pool.sd = FALSE)
```

## Visualization
```{r, warning=FALSE, message=FALSE}
unitedData %>% 
    drop_na(unitedEducation, unitedPurchase) %>% 
  ggplot(aes(x = unitedEducation, y = unitedPurchase, fill = unitedEducation)) + 
    geom_bar(stat = 'summary', position = position_dodge()) +
      geom_jitter(aes(x = unitedEducation, y = unitedPurchase, fill = unitedEducation), color = 'blue') + 
    stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), 
               geom = "errorbar", color = "red", width = 0.2) +
    stat_summary(fun.y = mean, geom = "point", color = "red") +
    theme_classic() + ylab('Purchase') + xlab('Education level') + 
    ggtitle('One-Way ANOVA bar plot: Purchase by Education') + theme(plot.title = element_text(hjust = 0.5)) 
```


# Hypothesis testing - Kruskal-Wallis (if the N of the smallest group is lower than 30)
## Model and summary statistics
The Kruskal-Wallis test is performed using the **kruskal.test** command.
```{r, warning=FALSE, message=FALSE}
modelVarEqual <- kruskal.test(unitedPurchase ~ unitedEducation, data = unitedData)   # If the Variances are equal
modelVarEqual
```

## Post hoc pairwise comparisons
The pairwise.wilcox.test conduced all the pairwise comparisons. The X item is the response vector and the g item is the grouping vector or factor.
```{r, warning=FALSE, message=FALSE}
pairwise.wilcox.test(x = unitedData$unitedPurchase, g = unitedData$unitedEducation, 
                 p.adjust.method = "bonferroni")
```


## Summary statistics
```{r, warning=FALSE, message=FALSE}
unitedData %>% 
  drop_na(unitedEducation, unitedPurchase) %>% 
  group_by(unitedEducation) %>% 
  summarise(Median = round(median(unitedPurchase), 2),
            N    = length(unitedPurchase))
```

## Visualization
```{r, warning=FALSE, message=FALSE}
unitedData %>% 
  drop_na(unitedEducation, unitedPurchase) %>% 
  ggplot(aes(x = unitedEducation, y = unitedPurchase, fill = unitedEducation)) + 
    geom_boxplot(color = 'red') +
    geom_jitter(aes(x = unitedEducation, y = unitedPurchase, fill = unitedEducation), color = 'blue', alpha = 0.2) +
    theme_classic() + ylab('Purchase') +
    ggtitle('Kruskal-Wallis test box plot: Purchase by Education') + theme(plot.title = element_text(hjust = 0.5)) 
```
